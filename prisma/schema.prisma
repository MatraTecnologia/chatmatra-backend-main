generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Better Auth ────────────────────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  signature     String?  // Assinatura eletrônica do usuário (suporta variáveis: {{name}}, {{email}}, {{phone}})
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions         Session[]
  accounts         Account[]
  members          Member[]
  invitations      Invitation[]
  assignedContacts Contact[]    @relation("AssignedContacts")

  @@map("users")
}

model Session {
  id                   String   @id @default(cuid())
  userId               String
  token                String   @unique
  expiresAt            DateTime
  ipAddress            String?
  userAgent            String?
  activeOrganizationId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ─── Multi-Tenant (Organizations) ───────────────────────────────────────────

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String?  @unique
  logo      String?
  domain    String?  @unique  // domínio da empresa (ex: empresa.com.br)
  metadata  String?
  createdAt DateTime @default(now())

  members     Member[]
  invitations Invitation[]
  channels    Channel[]
  contacts    Contact[]
  messages    Message[]
  tags        Tag[]
  campaigns   Campaign[]
  aiAgents       AiAgent[]
  customRoles    CustomRole[]
  emailTemplates EmailTemplate[]
  // Facebook App credentials (por organização)
  fbAppId     String?
  fbAppSecret String?

  @@map("organizations")
}

// ─── Channels ────────────────────────────────────────────────────────────────

model Channel {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  type           String   // 'api' | 'whatsapp'
  status         String   @default("pending")
  // pending | connecting | connected | disconnected
  config         Json?
  // whatsapp: { instanceName, phone }
  // api:      { apiKey }
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]
  messages     Message[]

  @@map("channels")
}

// ─── Contacts ─────────────────────────────────────────────────────────────────

model Contact {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  phone          String?
  email          String?
  avatarUrl      String?
  channelId      String?  // canal de origem (opcional)
  externalId     String?  // ID externo (ex: número WhatsApp)
  notes          String?
  assignedToId   String?
  convStatus     String   @default("open")  // 'open' | 'pending' | 'resolved'
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channel      Channel?     @relation(fields: [channelId], references: [id], onDelete: SetNull)
  assignedTo   User?        @relation("AssignedContacts", fields: [assignedToId], references: [id], onDelete: SetNull)
  messages      Message[]
  tags          ContactTag[]
  campaignLeads CampaignLead[]

  @@map("contacts")
}

// ─── Messages ─────────────────────────────────────────────────────────────────

model Message {
  id             String   @id @default(cuid())
  organizationId String
  contactId      String
  channelId      String?
  direction      String   @default("outbound") // 'outbound' | 'inbound'
  type           String   @default("text")     // 'text' | 'note'
  content        String
  status         String   @default("sent")     // 'sent' | 'error' | 'delivered' | 'read'
  externalId     String?  // ID da mensagem na Evolution API
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  channel      Channel?     @relation(fields: [channelId], references: [id], onDelete: SetNull)

  @@map("messages")
}

// ─── Tags ──────────────────────────────────────────────────────────────────────

model Tag {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  color          String   @default("#6366f1")
  waLabelId      String?  // ID numérico da label no WhatsApp (ex: "1", "2")
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     ContactTag[]

  @@map("tags")
}

model ContactTag {
  contactId String
  tagId     String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@map("contact_tags")
}

model Member {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   @default("member")
  customRoleId   String?  // papel personalizado (opcional)
  // Configurações de notificações
  notifyNewMessage  Boolean  @default(true)  // Notificar em novas mensagens
  notifyAssigned    Boolean  @default(true)  // Notificar quando atribuído a uma conversa
  notifyMention     Boolean  @default(true)  // Notificar em menções (@nome)
  notifyResolved    Boolean  @default(false) // Notificar quando conversas são resolvidas
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  customRole   CustomRole?  @relation(fields: [customRoleId], references: [id], onDelete: SetNull)

  @@unique([organizationId, userId])
  @@map("members")
}

model CustomRole {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  color          String   @default("#6366f1")
  permissions    Json     // OrgPermissions: ver conversas, enviar msgs, etc.
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      Member[]

  @@map("custom_roles")
}

model Invitation {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           String?  @default("member")
  status         String   @default("pending")
  expiresAt      DateTime
  inviterId      String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitations")
}

// ─── Campaigns ────────────────────────────────────────────────────────────────

model Campaign {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  description    String?
  status         String    @default("active")  // 'active' | 'paused' | 'ended'
  keywords       Json      @default("[]")       // string[]
  startDate      DateTime?
  endDate        DateTime?
  goalLeads      Int?
  sourceChannel  String    @default("all")      // 'all' | 'facebook' | 'whatsapp' | 'widget'
  // Facebook Lead Ads (por campanha)
  fbPageId       String?
  fbPageToken    String?   // Page Access Token (long-lived) — gerado pelo usuário via Meta Business Suite
  fbFormIds      Json      @default("[]")       // string[] — IDs dos formulários monitorados
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  leads        CampaignLead[]

  @@map("campaigns")
}

model CampaignLead {
  id         String   @id @default(cuid())
  campaignId String
  contactId  String?
  fbLeadId   String?  @unique  // ID do lead no Facebook (deduplicação)
  source     String   @default("facebook")
  formName   String?
  rawData    Json?    // todos os campos do formulário Facebook
  createdAt  DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@map("campaign_leads")
}

// ─── AI Agents ────────────────────────────────────────────────────────────────

model AiAgent {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           String   @default("support")    // 'support' | 'sales' | 'financial' | 'hr' | 'custom'
  model          String   @default("gpt-4o-mini") // 'gpt-4o' | 'gpt-4o-mini' | 'gpt-3.5-turbo'
  apiKey         String?
  systemPrompt   String?
  temperature    Float    @default(0.7)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  channelIds   Json      @default("[]")  // string[] — IDs dos canais monitorados
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  files        AiAgentFile[]
  rules        AgentRule[]

  @@map("ai_agents")
}

model AgentRule {
  id             String   @id @default(cuid())
  agentId        String
  name           String
  active         Boolean  @default(true)
  priority       Int      @default(0)

  // Condição (QUANDO): 'keyword_match' | 'message_count' | 'no_ai_response' | 'hours_outside' | 'always'
  conditionType  String
  conditionValue Json?

  // Ação (ENTÃO): 'transfer_human' | 'assign_agent' | 'stop_responding' | 'send_message' | 'add_tag'
  actionType     String
  actionValue    Json?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  agent          AiAgent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_rules")
}

model AiAgentFile {
  id        String   @id @default(cuid())
  agentId   String
  name      String
  mimeType  String
  category  String   @default("general") // 'general' | 'prices' | 'products' | 'tips' | 'faq'
  sizeBytes Int
  content   String   // base64 do arquivo
  createdAt DateTime @default(now())

  agent AiAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("ai_agent_files")
}

// ─── Email Templates ──────────────────────────────────────────────────────────

model EmailTemplate {
  id             String   @id @default(cuid())
  organizationId String
  // 'verification' | 'magic-link' | 'reset-password' | 'otp-sign-in' | 'otp-verification' | 'otp-forget-password'
  type           String
  subject        String
  html           String   // HTML final renderizado
  design         Json?    // JSON do Unlayer para re-edição

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, type])
  @@map("email_templates")
}
